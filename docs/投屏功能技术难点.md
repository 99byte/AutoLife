# 投屏功能技术难点记录

## 日期
2025-12-21

## 问题概述
尝试实现基于 scrcpy + ffmpeg 的流式投屏功能时，遇到数据管道无法正常工作的问题。

## 技术方案

### 方案 1：ADB screencap（已实现但性能不佳）
- **实现方式**: `adb exec-out screencap -p | OpenCV 解码 | JPEG 编码 | WebSocket`
- **问题**: 每次截图耗时 2.2 秒，实际帧率只有 0.4 FPS
- **代码位置**: `src/autolife/scrcpy/manager.py` (旧版本)

### 方案 2：scrcpy + ffmpeg 管道（失败）
- **实现方式**:
  ```bash
  scrcpy --video-source=display --no-audio --no-control --no-window \
         --max-size=720 --max-fps=15 --record=- --record-format=mkv | \
  ffmpeg -i pipe:0 -f image2pipe -vcodec mjpeg -q:v 3 pipe:1
  ```
- **问题**: scrcpy 和 ffmpeg 进程都正常启动，但没有数据输出
- **现象**:
  - scrcpy 成功推送 server 到设备
  - ffmpeg 输出版本信息后就没有其他输出
  - 进程都在运行但没有数据流动
  - 等待 10+ 秒仍无输出

- **代码位置**: `src/autolife/scrcpy/manager.py` (当前版本)

## 可能的原因分析

1. **scrcpy `--no-window` + `--record=-` 组合问题**
   - scrcpy 可能需要窗口才能正常工作
   - `--record=-` 输出到 stdout 可能有特殊要求
   - 可能需要等待某些初始化信号

2. **MKV 容器格式问题**
   - MKV 容器可能需要 seekable stream
   - stdout 是非 seekable 的管道
   - ffmpeg 可能在等待完整的 MKV header

3. **管道缓冲问题**
   - Python subprocess 的管道可能有缓冲限制
   - 需要异步读取避免阻塞

## 测试结果

### 成功的命令
```bash
# 录制到文件（成功）
scrcpy --video-source=display --no-audio --no-control --no-window \
       --max-size=720 --max-fps=15 --record=/tmp/test.mkv --record-format=mkv
# 生成 166KB 文件，3 秒内完成
```

### 失败的命令
```bash
# 输出到 stdout（失败 - 无输出）
scrcpy --video-source=display --no-audio --no-control --no-window \
       --max-size=720 --max-fps=15 --record=- --record-format=mkv | \
ffmpeg -i pipe:0 -f image2pipe -vcodec mjpeg -q:v 3 pipe:1
```

## 尝试过的修复

1. ✅ 增加 ADB 命令超时时间（2s → 5s）
2. ✅ 启用 stderr 调试输出
3. ✅ 修复 stdout 关闭问题（不要关闭 scrcpy.stdout）
4. ✅ 添加独立线程读取 stderr
5. ❌ 数据仍然无法流动

## 替代方案

### 方案 A：优化的 ADB screencap
- 降低分辨率（360p 或 480p）
- 提高 JPEG 压缩率
- 预计帧率：1-2 FPS
- **优点**: 简单可靠，立即可用
- **缺点**: 帧率低，用户体验差

### 方案 B：scrcpy GUI 模式
- 直接运行 `scrcpy --max-size=720`
- 在独立窗口显示
- **优点**: 完美的流式体验（15-60 FPS）
- **缺点**: 不在 Web 界面中，需要额外窗口

### 方案 C：ws-scrcpy 项目
- 使用现成的 WebSocket scrcpy 方案
- GitHub: https://github.com/NetrisTV/ws-scrcpy
- **优点**: 成熟方案，经过验证
- **缺点**: 依赖 Node.js，架构复杂

### 方案 D：Android screenrecord
- 使用 `adb shell screenrecord --output-format=h264 -`
- **问题**: screenrecord 有时间限制（最长 180 秒）
- **问题**: 需要重启命令才能持续录制

## 相关文件

- `src/autolife/scrcpy/manager.py` - ScrcpyManager 实现
- `src/autolife/api/routes/scrcpy.py` - WebSocket 路由
- `autolife-web/src/hooks/useScrcpy.ts` - 前端 Hook
- `autolife-web/src/components/ScreenMirror.tsx` - 投屏组件

## 环境信息

- scrcpy 版本: 3.3.3
- ffmpeg 版本: 8.0.1
- 设备: Google Pixel 8 Pro (Android 16)
- ADB 连接: USB (device ID: 39251FDJG007QK)
- 系统: macOS (Darwin 25.2.0)

## 后续建议

1. **短期**: 暂时搁置流式投屏，使用 scrcpy GUI 或不提供投屏功能
2. **中期**: 研究 scrcpy 源码，了解 `--record=-` 的实现细节
3. **长期**: 考虑集成 ws-scrcpy 或开发自定义 scrcpy 客户端

## 参考资料

- scrcpy 官方文档: https://github.com/Genymobile/scrcpy
- scrcpy 录制功能: https://github.com/Genymobile/scrcpy/blob/master/doc/recording.md
- ws-scrcpy 项目: https://github.com/NetrisTV/ws-scrcpy

## 相关 Issue

可以在 scrcpy GitHub 上搜索相关问题：
- "record stdout"
- "no-window record"
- "streaming"
